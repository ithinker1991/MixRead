# 功能概览: 域名排除列表

**功能名称**: MixRead 域名黑名单 (Exclude Domains)
**状态**: PRD已完成,待开发
**优先级**: 中等 (改进用户体验)
**预估工时**: 4-5天

---

## 快速概览

### 问题
MixRead插件在所有网站启用,包括内部工具页面(如库管理页面),导致页面混乱。

### 解决方案
用户可以维护一个**排除列表**,禁用某些网站的高亮功能。

### 核心功能
```
1. 添加/删除排除域名
2. 当前页面一键禁用
3. 查看和管理排除列表
4. 导入/导出备份
5. 预设排除列表 (新用户首次使用时建议)
```

---

## 一图胜千言

### 用户界面流程

```
用户打开插件Popup
         ↓
    ┌────────────────────────┐
    │ Current Page Controls  │
    ├────────────────────────┤
    │ Domain: localhost:8002 │
    │ Status: ✓ Enabled      │
    │ [Disable This Site]    │
    └────────────────────────┘
         ↓
    用户点击禁用
         ↓
    ┌────────────────────────┐
    │ Domain added to list   │
    │ Refresh page to apply  │
    └────────────────────────┘
         ↓
    用户刷新页面
         ↓
    MixRead 在该网站禁用 ✓
```

### 数据流

```
排除列表数据
    ↓
chrome.storage.local
    ↓
content.js 加载时检查
    ↓
如果被排除 → 不加载高亮
如果未被排除 → 正常加载
```

---

## 功能详细说明

### 1. 排除列表管理

**Popup中显示**:
```
Excluded Domains (3):
• localhost:8002  [×]
• 127.0.0.1:8000  [×]
• api.example.com [×]
```

**用户可以**:
- ✅ 点击 [×] 删除任何域名
- ✅ 输入新域名添加
- ✅ 清空整个列表
- ✅ 导入/导出JSON备份

### 2. 当前页面控制

**快速操作**:
```
当前页面: localhost:8002
状态: ✓ 启用

[🚫 禁用此网站] 按钮

← 或 →

当前页面: localhost:8002
状态: ✗ 禁用

[✓ 启用此网站] 按钮
```

### 3. 预设排除列表 (新用户体验)

**首次使用建议**:
```
✓ localhost:8002      → MixRead库页面
✓ localhost:3000      → React/Vue开发服务器
✓ 127.0.0.1:8000      → 本地后端API
✓ localhost:5173      → Vite开发服务器
✓ file://             → 本地文件
✓ jenkins.company.com → Jenkins
✓ gitlab.company.com  → GitLab
✓ jira.company.com    → Jira
```

**首次设置流程**:
```
新用户首次打开Popup
    ↓
显示预设建议对话框
    ↓
用户勾选需要排除的网站 ☑
    ↓
点击 [✓ Apply] 应用
    ↓
预设列表自动加入排除列表 ✓
```

### 4. 域名匹配规则

**支持的格式**:
```
✓ github.com           → 精确匹配域名
✓ localhost:8002       → 包含端口
✓ 127.0.0.1:3000       → IP地址
✓ localhost:*          → 通配符匹配所有端口
✗ http://example.com   → 无需协议前缀
✗ example.com/path     → 无需路径
```

**匹配逻辑**:
```javascript
function shouldHighlight(currentURL, excludedList) {
  // 精确匹配: example.com === example.com
  // 通配符: localhost:* 匹配 localhost:8000, localhost:8001 等
  // 端口: localhost 和 localhost:80 视为相同
  // 协议: http 和 https 视为相同
}
```

---

## 实现概览

### 新增模块结构

```
frontend/modules/exclusion/
├── exclusion-store.js      # 数据存储和查询
├── exclusion-filter.js     # 域名匹配逻辑
└── exclusion-ui.js         # Popup UI交互
```

### 修改现有文件

```
popup.js
  + 添加排除列表UI部分
  + 添加添加/删除事件处理
  + 显示当前页面状态

content.js
  + 在加载前检查排除列表
  + 如果被排除则提前返回
```

### 存储格式

```javascript
// chrome.storage.sync (云端同步)
{
  mixread_excluded_domains: [
    "localhost:8002",
    "127.0.0.1:8000",
    "api.example.com"
  ],
  exclusion_updated_at: "2025-12-02T10:30:00Z"
}

// 特点:
// ✅ 自动在 Chrome 账户登录的所有设备间同步
// ✅ 用户换设备时配置自动跟随
// ✅ 离线时本地缓存, 恢复时自动同步
// ✅ 数据存储在 Google 云端, 安全可靠
```

---

## 用户故事

### Story 1: 禁用工具页面
```
作为: 开发者
我想: 禁用内部工具的高亮
以便: 工具页面显示不混乱

操作流程:
1. 打开库管理页面 (localhost:8002/library-viewer.html)
2. 发现页面有很多高亮和Tooltip,显示混乱
3. 点击插件Popup
4. 看到当前域名是 "localhost:8002"
5. 点击 [禁用此网站]
6. Popup显示 "已添加到排除列表"
7. 刷新页面
8. 页面不再有高亮 ✓
```

### Story 2: 管理排除列表
```
作为: 用户
我想: 查看和编辑排除的网站
以便: 可以随时启用或禁用

操作流程:
1. 打开插件Popup
2. 滚动到 "Excluded Domains" 部分
3. 看到列表有3个网站
4. 想重新启用某个网站
5. 点击该网站旁的 [×]
6. 网站被删除 ✓
7. 该网站下次访问时恢复高亮
```

### Story 3: 备份和恢复
```
作为: 用户
我想: 备份排除列表,换电脑时恢复
以便: 不用重新配置

操作流程:
1. 打开Popup
2. 点击 [导出]
3. 下载 mixread-exclusions.json
4. 在新电脑上安装插件
5. 点击 [导入]
6. 选择之前下载的JSON
7. 列表自动恢复 ✓
```

### Story 4: 首次使用预设建议
```
作为: 新用户
我想: 快速配置好常见的排除网站
以便: 不用手动一个个添加

操作流程:
1. 首次安装插件,打开Popup
2. 看到 "Welcome to MixRead!" 对话框
3. 显示推荐排除的网站列表:
   ☑ localhost:8002 (Library page)
   ☑ localhost:3000 (Dev server)
   ☑ 127.0.0.1:8000 (Local API)
   ☑ file://
   ☐ jenkins.company.com
   ☐ gitlab.company.com
4. 根据需要勾选/取消勾选
5. 点击 [✓ Apply] 按钮
6. 预设的网站自动添加到排除列表 ✓
7. 下次打开Popup时不再显示对话框
```

### Story 5: 云端同步配置
```
作为: 用户
我想: 换了新电脑后,排除列表自动跟随
以便: 无缝转移,不用重新配置

操作流程:
1. 在电脑A上配置好排除列表
   • 添加了 10 个排除的网站
   • 禁用了公司内部工具

2. 登出电脑A的 Chrome 账户

3. 在新电脑B上登录同一 Chrome 账户
   • 安装 MixRead 插件

4. 打开 Popup
   • ✅ 所有 10 个排除的网站自动出现
   • ✅ 无需任何手动操作

5. 配置完全迁移 ✓
   • 云端同步自动处理
   • 用户体验无缝

原理: chrome.storage.sync 自动在 Google 云端保存,
      用户换设备时自动下载到新设备
```

---

## 技术亮点

### 1. 云端同步 (跨设备)
- 自动同步到所有登录的 Chrome 账户的设备
- 换设备时配置无缝迁移
- 离线时本地缓存,恢复自动同步
- 数据安全: Google 官方加密存储
- 同步延迟: 通常 <1 秒
- 无额外开发成本: 使用 Chrome 原生 API

### 2. 零性能影响
- 检查时间 <10ms (即使排除列表很大)
- 检查方式: 字符串比较,无复杂计算

### 3. 优雅的降级
```javascript
// 如果 ExclusionStore 失败,继续加载
try {
  isExcluded = await exclusionStore.isDomainExcluded(url);
} catch (e) {
  // 失败时默认启用 (安全默认)
  isExcluded = false;
}

if (!isExcluded) {
  // 正常加载高亮
  initializeHighlight();
}
```

### 4. 灵活的匹配
```javascript
// 支持多种域名格式
"localhost:8002"   // 完整指定
"localhost:*"      // 通配符
"api.github.com"   // 子域名
"*.company.com"    // (可选Phase 2)
```

---

## 预期收益

### 用户体验
- ✅ 内部工具页面不再混乱
- ✅ 快速禁用/启用特定网站
- ✅ 排除列表便携(导入/导出)

### 产品
- ✅ 提高易用性
- ✅ 减少用户配置时间
- ✅ 支持多场景使用

### 技术
- ✅ 清晰的模块化设计
- ✅ 为Phase 2白名单模式铺垫
- ✅ 可扩展的规则引擎基础

---

## 实现步骤

### Phase 1: MVP (本期)
```
1. 创建 exclusion-store.js
   └─ 实现数据存储、添加、删除、查询

2. 创建 exclusion-filter.js
   └─ 实现域名匹配逻辑

3. 更新 content.js
   └─ 在加载前检查排除列表

4. 更新 popup.js 和 popup.html
   └─ 添加UI和事件处理
   └─ 包括预设列表首次使用建议对话框

5. 预设列表初始化
   └─ 首次使用检测
   └─ 预设建议对话框显示
   └─ 用户选择和应用

6. 测试和优化
   └─ 功能测试、性能测试、边界情况
```

### Phase 2: 增强功能
```
- 导入/导出功能
- 预设列表自定义管理
- UI微调
- 文档完善
```

### Phase 3: 高级功能
```
- 白名单模式
- 规则引擎
- 云端同步
```

---

## 测试场景

### 场景1: 基础添加和删除
```
1. 添加 "localhost:8002" 到排除列表
2. 验证该网站被排除
3. 从列表删除
4. 验证该网站恢复高亮
```

### 场景2: 通配符匹配
```
1. 添加 "localhost:*" 到排除列表
2. 验证 localhost:8000, localhost:8001 都被排除
3. 验证其他网站正常高亮
```

### 场景3: 多端口
```
1. 添加 "127.0.0.1:8000" 到排除列表
2. 验证该端口被排除
3. 验证 "127.0.0.1:8001" 不被排除
```

### 场景4: 导入/导出
```
1. 创建排除列表
2. 点击导出
3. 清空列表
4. 点击导入之前导出的文件
5. 验证列表恢复
```

---

## 风险和缓解

| 风险 | 影响 | 缓解方案 |
|------|------|--------|
| 用户误删整个列表 | 需要手动重新配置 | 提供[清空确认]对话框 + 导出提示 |
| 性能下降 | 影响插件启动 | 检查时间目标 <10ms |
| 兼容性问题 | 某些URL格式无法识别 | 详细的格式验证和错误提示 |
| 复杂的规则 | 用户困惑 | Phase 1只支持简单规则,提示清晰 |

---

## 完整PRD
详见: **PRD_EXCLUDE_DOMAINS_FEATURE.md**

包含:
- 详细的功能需求
- 完整的代码示例
- UI/UX设计图
- 验收标准
- 未来扩展计划

---

**创建日期**: 2025-12-02
**版本**: 1.0
**状态**: 待开发
**下一步**: 提交计划评审
