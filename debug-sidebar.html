<!DOCTYPE html>
<html>
  <head>
    <title>Sidebar Debug</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #f0f0f0;
      }
      .error {
        color: red;
        background: #ffe0e0;
        padding: 10px;
        margin: 5px 0;
        border-left: 4px solid red;
      }
      .success {
        color: green;
        background: #e0ffe0;
        padding: 10px;
        margin: 5px 0;
        border-left: 4px solid green;
      }
      .warning {
        color: orange;
        background: #fff0e0;
        padding: 10px;
        margin: 5px 0;
        border-left: 4px solid orange;
      }
      button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
        border-radius: 4px;
      }
      button:hover {
        background: #1976d2;
      }
      #debug-output {
        background: white;
        padding: 15px;
        border-radius: 4px;
        margin-top: 20px;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>üîç MixRead Sidebar Debug Tool</h1>

    <div id="status"></div>

    <h2>üß™ Debug Actions</h2>
    <button onclick="checkDependencies()">Check Dependencies</button>
    <button onclick="testSidebarInit()">Test Sidebar Init</button>
    <button onclick="testWordHighlighting()">Test Word Highlighting</button>
    <button onclick="testSidebarUpdate()">Test Sidebar Update</button>
    <button onclick="clearDebugOutput()">Clear Output</button>

    <h2>üìä Debug Output</h2>
    <div id="debug-output">Click buttons above to start debugging...</div>
    <script>
      function log(message, type = "info") {
        const output = document.getElementById("debug-output");
        const timestamp = new Date().toLocaleTimeString();
        const className =
          type === "error"
            ? "error"
            : type === "success"
            ? "success"
            : type === "warning"
            ? "warning"
            : "";

        output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        output.scrollTop = output.scrollHeight;
      }

      function updateStatus(message, type = "info") {
        const status = document.getElementById("status");
        const className =
          type === "error"
            ? "error"
            : type === "success"
            ? "success"
            : type === "warning"
            ? "warning"
            : "";

        status.innerHTML = `<div class="${className}">${message}</div>`;
      }

      function clearDebugOutput() {
        document.getElementById("debug-output").innerHTML = "";
      }

      function checkDependencies() {
        log("üîç Checking dependencies...");

        const deps = [
          { name: "UserStore", obj: window.UserStore },
          { name: "UnknownWordsStore", obj: window.UnknownWordsStore },
          { name: "UnknownWordsService", obj: window.UnknownWordsService },
          { name: "DomainPolicyStore", obj: window.DomainPolicyStore },
          { name: "DomainPolicyFilter", obj: window.DomainPolicyFilter },
          { name: "ContextMenu", obj: window.ContextMenu },
          { name: "HighlightFilter", obj: window.HighlightFilter },
          { name: "BatchMarkingPanel", obj: window.BatchMarkingPanel },
          { name: "WordCacheManager", obj: window.WordCacheManager },
          { name: "SidebarPanel", obj: window.SidebarPanel },
          { name: "Stemmer", obj: window.Stemmer },
          { name: "ChromeAPI", obj: window.ChromeAPI },
        ];

        let allFound = true;
        deps.forEach((dep) => {
          if (dep.obj) {
            log(`‚úÖ ${dep.name} found`);
          } else {
            log(`‚ùå ${dep.name} NOT found`, "error");
            allFound = false;
          }
        });

        if (allFound) {
          updateStatus("‚úÖ All dependencies loaded successfully", "success");
        } else {
          updateStatus("‚ùå Some dependencies are missing", "error");
        }
      }

      function testSidebarInit() {
        log("üß™ Testing sidebar initialization...");

        try {
          if (!window.wordCacheManager) {
            window.wordCacheManager = new window.WordCacheManager();
            log("‚úÖ Created WordCacheManager");
          }

          if (!window.sidebarPanel) {
            window.sidebarPanel = new window.SidebarPanel(
              window.wordCacheManager
            );
            log("‚úÖ Created SidebarPanel");
          }

          if (window.sidebarPanel && window.sidebarPanel.isInitialized) {
            log("‚úÖ SidebarPanel is initialized");
            updateStatus("‚úÖ Sidebar initialized successfully", "success");
          } else {
            log(
              "‚ö†Ô∏è  SidebarPanel not yet initialized (check if still loading)",
              "warning"
            );
            updateStatus("‚ö†Ô∏è  Sidebar still initializing...", "warning");
          }
        } catch (e) {
          log(`‚ùå Error during sidebar init: ${e.message}`, "error");
          updateStatus("‚ùå Sidebar initialization failed", "error");
        }
      }

      function testWordHighlighting() {
        log("üß™ Testing word highlighting...");

        try {
          // Check if content script variables exist
          if (typeof window.highlightedWordsMap !== "undefined") {
            const wordCount = Object.keys(window.highlightedWordsMap).length;
            log(`üìä highlightedWordsMap has ${wordCount} words`);
          } else {
            log("‚ùå highlightedWordsMap not found", "error");
          }

          // Check for highlighted elements in DOM
          const highlights = document.querySelectorAll(".mixread-highlight");
          log(`üìä Found ${highlights.length} highlighted elements in DOM`);

          if (highlights.length > 0) {
            const firstWord = highlights[0].dataset.word;
            log(`üìù First highlighted word: "${firstWord}"`);
          }

          if (
            highlights.length === 0 &&
            typeof window.highlightPageWords === "function"
          ) {
            log("üîÑ Triggering highlightPageWords()...");
            window.highlightPageWords();
          }
        } catch (e) {
          log(`‚ùå Error during word highlighting test: ${e.message}`, "error");
        }
      }

      function testSidebarUpdate() {
        log("üß™ Testing sidebar update...");

        try {
          if (!window.sidebarPanel) {
            log("‚ùå SidebarPanel not available", "error");
            return;
          }

          // Create test word data
          const testWords = {
            test: {
              count: 1,
              originalWords: ["test"],
              chinese: "ÊµãËØï",
              definition:
                "a procedure intended to establish the quality of something",
              cefrLevel: "A2",
            },
          };

          log("üìù Sending test words to sidebar...");
          window.sidebarPanel.onNewWordsHighlighted(testWords);

          setTimeout(() => {
            log("‚úÖ Test words sent to sidebar");
            updateStatus("‚úÖ Sidebar update test completed", "success");
          }, 500);
        } catch (e) {
          log(`‚ùå Error during sidebar update test: ${e.message}`, "error");
        }
      }

      // Auto-run dependency check on page load
      window.addEventListener("load", () => {
        setTimeout(checkDependencies, 1000);
      });
    </script>
  </body>
</html>
