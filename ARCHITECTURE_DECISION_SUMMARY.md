# 域名排除功能 - 架构决策汇总

**日期**: 2025-12-02
**状态**: 🔄 待决策
**相关文档**:
- `CLOUD_SYNC_IMPLEMENTATION_GUIDE.md` (Chrome Cloud Sync方案)
- `PRD_EXCLUDE_DOMAINS_FEATURE.md` (完整需求)
- `FEATURE_OVERVIEW_EXCLUDE_DOMAINS.md` (功能概览)

---

## 📊 两大架构方案对比

### 方案 A: Chrome Cloud Sync ⭐ 推荐

**特点**: 利用 Chrome 官方 API，自动云端同步

| 维度 | 详情 |
|------|------|
| **开发成本** | 1-2 天 (实现 ExclusionStore + 同步检测) |
| **服务器成本** | $0/月 (Google 免费) |
| **用户体验** | ⭐⭐⭐⭐⭐ (最佳，无需登录) |
| **可靠性** | ⭐⭐⭐⭐⭐ (Google 99.99% 可用性) |
| **维护成本** | 零 (Google 全包) |
| **离线支持** | ✅ 完美 (本地缓存) |
| **覆盖率** | 70-80% 自动同步 + 15-20% 手动备份 + 5-10% 本地 |
| **部署复杂度** | ⭐ (极简) |

**优点**:
- ✅ Google Cloud 自动加密存储
- ✅ 跨设备无缝同步 (~1秒)
- ✅ 用户无需额外登录（使用现有 Chrome 账户）
- ✅ 离线时本地缓存，恢复后自动同步
- ✅ 完全符合 Google 隐私政策
- ✅ 零运维成本
- ✅ 自动冲突解决 (last-write-wins)
- ✅ 100KB 限制足够存储数万条域名

**缺点**:
- ❌ 5-10% 用户未登录 Chrome 账户（降级到本地存储）
- ❌ 依赖 Google 服务（但极少出现故障）
- ❌ 无自定义冲突解决策略

**实现流程**:
```
Week 1: ExclusionStore (CRUD + sync 检测)
    ↓
Week 2: Popup UI + 预设对话框
    ↓
Week 3: content.js 集成 + 预设初始化
    ↓
完成！部署到用户
```

**关键代码** (已在 CLOUD_SYNC_IMPLEMENTATION_GUIDE.md 中提供):
```javascript
async getExcludedDomains() {
  const useSyncStorage = await this.isSyncAvailable();
  const storage = useSyncStorage
    ? chrome.storage.sync
    : chrome.storage.local;
  // ... 获取配置
}
```

---

### 方案 B: 自托管服务器

**特点**: 将配置存储在自有后端服务器，类似单词本存储

| 维度 | 详情 |
|------|------|
| **开发成本** | 2-3 天 (添加 API + 数据库 + 冲突解决) |
| **服务器成本** | $70-180/月 ($840-2160/年) |
| **用户体验** | ⭐⭐⭐⭐ (良好，需登录) |
| **可靠性** | ⭐⭐⭐ (取决于我们的运维) |
| **维护成本** | 中等 (数据库备份、API 监控、GDPR 合规) |
| **离线支持** | ⚠️ 需另外实现 (本地缓存 + 同步队列) |
| **覆盖率** | 100% (需登录账户) |
| **部署复杂度** | ⭐⭐⭐ (中等) |

**优点**:
- ✅ 完全控制用户数据
- ✅ 可自定义冲突解决逻辑
- ✅ 100% 用户覆盖（所有登录用户）
- ✅ 可与其他用户数据集成
- ✅ 便于添加高级功能（如共享配置）
- ✅ 数据分析和审计方便

**缺点**:
- ❌ 每月 $70-180 服务器成本
- ❌ 需要数据库维护和备份
- ❌ 需要 API 监控和告警
- ❌ GDPR 数据保护责任
- ❌ 新用户需额外登录流程
- ❌ 离线支持需特殊设计
- ❌ 同步冲突需手动处理逻辑
- ❌ 依赖我们团队的运维能力

**实现流程**:
```
Week 1: 后端 API 设计 + 数据库 schema
    ↓
Week 2: CRUD API + 身份验证 + 冲突解决
    ↓
Week 3: 前端集成 + 离线队列 + 冲突 UI
    ↓
完成！需要持续运维
```

**架构对比**:
```
Chrome Cloud Sync:
  前端 → chrome.storage.sync → Google Cloud
  优点: 0 维护，自动同步

自托管服务器:
  前端 → 我们的 API → 我们的数据库
  优点: 完全控制，缺点: 持续维护
```

---

## 🔍 用户场景分析

### 场景 1: 用户 A - 登录 Chrome 账户

**Chrome Cloud Sync**:
```
✅ 设备 A: 添加排除域名 → 自动上传到 Google Cloud (~1秒)
✅ 设备 B: 登同一 Google 账户 → 自动下载配置
✅ 设备 C: 重新安装系统 → 恢复账户后配置自动出现
```
**体验**: 无缝，零配置

**自托管服务器**:
```
✅ 设备 A: 添加排除域名 → 上传到我们的服务器
⚠️ 设备 B: 需登录 MixRead 账户 → 下载配置
⚠️ 设备 C: 重新安装系统 → 需重新登录
```
**体验**: 良好，但需额外登录步骤

---

### 场景 2: 用户 B - 未登录 Chrome 账户（10% 用户）

**Chrome Cloud Sync**:
```
✅ 设备 A: 本地存储，正常使用
⚠️ 设备 B: 换电脑 → 配置丢失，需手动导入 JSON
```
**体验**: 需要手动备份/恢复

**自托管服务器**:
```
✅ 设备 A: 登录 MixRead → 正常使用
✅ 设备 B: 登录 MixRead → 配置自动同步
```
**体验**: 完全无缝

---

### 场景 3: 数据隐私 (GDPR/隐私政策)

**Chrome Cloud Sync**:
```
✅ 受 Google 隐私政策保护
✅ Google 负责数据安全和合规
✅ 我们仅是扩展开发者，不处理个人数据
✅ 简化隐私声明
```

**自托管服务器**:
```
⚠️ 我们是数据控制者
⚠️ 需要完整的隐私政策和 GDPR 合规
⚠️ 用户有权访问/删除数据的权利
⚠️ 需要数据处理协议 (DPA)
```

---

## 💰 成本分析

### Chrome Cloud Sync
```
一次性成本:
  开发: 1-2 天 × 团队 = ~2000-4000 RMB

月度成本:
  Google Cloud: $0
  总计: $0/月

年度成本:
  开发: ~2000-4000 RMB (一次性)
  运维: $0
  总计: ~2000-4000 RMB
```

### 自托管服务器
```
一次性成本:
  开发: 2-3 天 × 团队 = ~3000-6000 RMB

月度成本:
  服务器 (VPS): $70-180/月
  数据库备份: $20-50/月 (可选)
  CDN/监控: $10-30/月 (可选)
  总计: $100-260/月

年度成本:
  开发: ~3000-6000 RMB (一次性)
  运维: $1200-3120/年
  总计: ~12000-25000 RMB/年
```

**5年总拥有成本 (TCO)**:
- Chrome Cloud Sync: ~2000-4000 RMB
- 自托管服务器: ~60000-125000 RMB

---

## 🎯 推荐方案

### ⭐ 强烈推荐: Chrome Cloud Sync

**理由**:
1. **成本效益最优**: 0 运维成本，一次性开发
2. **用户体验最佳**: 无登录，自动同步，完全无感
3. **可靠性最高**: 依赖 Google，99.99% 可用性
4. **合规最简单**: Google 负责隐私和安全合规
5. **快速上市**: 1-2 天即可发布，而不是 2-3 天
6. **符合产品哲学**: 简单、适用、演进
   - 简单: 无须额外登录，零维护
   - 适用: 覆盖 70-80% 用户，+ 手动导出作为降级
   - 演进: Phase 2 可加强导入/导出功能

### 何时选择自托管方案?
仅在以下情况:
- ❌ 公司有严格的 Google 使用禁令
- ❌ 用户群体主要在未登录 Chrome 账户的地区
- ❌ 需要完全控制用户行为数据用于分析
- ❌ 团队有充足的运维资源

**目前均不满足** → 优先使用 Chrome Cloud Sync

---

## 📋 混合方案: 最佳实践

可以同时支持两种同步:

```javascript
// Week 1-3: 实现 Chrome Cloud Sync
ExclusionStore.getExcludedDomains()
  → 尝试 chrome.storage.sync (70-80% 用户)
  → 降级到 chrome.storage.local (20-30% 用户)
  → 支持手动导入/导出 JSON

// Phase 2 (未来): 可选添加服务器同步
// 用户可选: 启用账户同步选项
// 自动检测已登录 MixRead 账户
// 同步配置到服务器 (可选功能)
```

**优点**:
- ✅ 立即发布 Phase 1 (Chrome Cloud Sync)
- ✅ 获得用户反馈
- ✅ Phase 2 根据需求评估是否需要服务器方案
- ✅ 不需要一开始就做出永久性承诺

---

## 🚀 立即开始

### 确认决策后的后续步骤

**如果选择 Chrome Cloud Sync**:
```
[ ] 阅读: CLOUD_SYNC_IMPLEMENTATION_GUIDE.md
[ ] 启动 Week 1: 创建 ExclusionStore
[ ] 包含: sync 检测逻辑 + 降级方案
[ ] 测试: 单设备 + 多设备 + 离线场景
[ ] 完成: 部署到 Chrome Store
```

**如果选择自托管方案**:
```
[ ] 设计: API endpoints 和数据库 schema
[ ] 实现: 后端 CRUD + 冲突解决
[ ] 集成: 前端身份验证和离线队列
[ ] 测试: 多设备同步和冲突场景
[ ] 部署: 服务器 + 前端更新
```

---

## ✅ 检查清单

- [ ] **决策已做**: 选择 Chrome Cloud Sync 或自托管
- [ ] **团队同意**: 确认选择符合产品战略
- [ ] **资源确认**: 开发人员有时间在 Week 1-3 完成
- [ ] **外部依赖**: 无 (Chrome Cloud Sync) 或确认服务器就绪 (自托管)

---

## 📞 决策点

**用户需要确认**:

选择哪一个方案？

```
A) Chrome Cloud Sync (推荐)
   - 零成本，最简单，最好的用户体验

B) 自托管服务器
   - 更多控制权，需要额外运维成本和工作量
```

一旦确认，开发计划已经准备好，可以立即启动 Week 1！

